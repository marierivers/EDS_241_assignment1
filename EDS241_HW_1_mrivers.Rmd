---
title: "EDS241: Assignment 1"
author: "Marie Rivers"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
--- 
  
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}

# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)

# load packages
packages=c("stargazer", "here", "tidyr", "dplyr","stringr", "janitor", 
           "cowplot", "ggplot2", "tinytex", "datasets", "tibble", "tidyverse", "readxl", "estimatr")

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

#devtools::install_github('rstudio/rmarkdown')
options(scipen=999) # not scientific notation
```

\noindent In this assignment, we use air quality data in R to investigate the relationship between PM2.5 and low birth weight in California. The data came from CalEnviroScreen 4.0, a mapping and data tool produced by the California Office of Environmental Health Hazards Assessment (OEHHA). The data are compiled and constructed from a variety of sources and cover all 8,035 census tracts in California. Source: [https://oehha.ca.gov/calenviroscreen/report/calenviroscreen-40](https://oehha.ca.gov/calenviroscreen/report/calenviroscreen-40)

# Read and Clean Data
```{r warning=FALSE}
data <- read_xlsx(here("data", "CES4.xlsx"), sheet = "CES4.0FINAL_results") %>% 
  rename(CensusTract = "Census Tract", TotalPopulation = "Total Population", CaliforniaCounty = "California County", LowBirthWeight = "Low Birth Weight", PM25 = "PM2.5") %>% 
  select(CensusTract, TotalPopulation, CaliforniaCounty, LowBirthWeight, PM25, Poverty) %>% 
  mutate(LowBirthWeight = as.numeric(LowBirthWeight))
```

# Question a:
What is the average concentration of PM2.5 across all census tracts in California?
```{r}
mean_pm25 <- mean(data$PM25)
```

\noindent Answer: The average concentration of PM2.5 across all census tracts in California is `r round(mean_pm25, 2)` $\mu g/m^3$.

# Question b:
What county has the highest level of poverty in California?
```{r}
county_pov <- data %>%
  mutate(pov_per_capita = Poverty/TotalPopulation) %>% 
  group_by(CaliforniaCounty) %>% 
  summarise(mean_pov = mean(Poverty, na.rm = TRUE),
            mean_pov_per_capita = mean(pov_per_capita, na.rm = TRUE)) 

county_max_pov <- county_pov$CaliforniaCounty[which.max(county_pov$mean_pov)]
county_max_pov_per_capita <- county_pov$CaliforniaCounty[which.max(county_pov$mean_pov_per_capita)]
```

\noindent Answer: `r county_max_pov` County has the highest level of poverty in California based on mean poverty for all census tracts in each county. I decided not to use the county with the highest level of poverty per capital (which would have been `r county_max_pov_per_capita`) because according to the CES4 data dictionary the `Poverty` variable represents the percent of population living below two times the federal poverty level.

\noindent Note: there are 75 census tracts with NA values for poverty

# Question c:
Make a histogram depicting the distribution of percent low birth weight and PM2.5

```{r eval=TRUE, echo=FALSE, fig.height=5, fig.width=7}
low_birth_weight_histogram <- ggplot(data = data, aes(x = LowBirthWeight)) +
  geom_histogram(fill = "seagreen") +
  labs(x = "Percent Low Birth Rate")
```

<center>**Figure 1: Percent Low Birth Weight for California Census Tracts**</center>
```{r, eval=TRUE, echo=FALSE}
low_birth_weight_histogram
```

\noindent Figure 1 shows the distribution of percent low birth weights for California Census Tracts as reported by the California Office of Environmental Health Assessment (OEHHA). Data Source: CalEnviroScreen 4.0.

```{r , fig.width = 7, fig.height = 5, eval=TRUE, echo=FALSE}
pm25_histogram <- ggplot(data = data, aes(x = PM25)) +
  geom_histogram(fill = "steelblue3") +
  labs(x = "PM2.5 (micrograms per cubic meter)")
```

\newpage
<center>**Figure 2: Air Quality for California Census Tracts**</center>
```{r, eval=TRUE, echo=FALSE}
pm25_histogram
```

\noindent Figure 2 shows the distribution of annual mean PM 2.5 concentrations for California Census Tracts as reported by the California Office of Environmental Health Assessment (OEHHA). Data Source: CalEnviroScreen 4.0.

# Question d:
Estimate a OLS regression of `LowBirthWeight` on `PM25`. Report the estimated slope coefficient and its heteroskedasticity-robust standard error. Interpret the estimated slope coefficient. Is the effect of PM2.5 on low birth weight statistically significant at the 5% level?

$$\text{percent low birth weight}_i=\beta_{0}+\beta_{1} \cdot PM2.5 + \varepsilon_i$$
```{r}
ols_model <- lm_robust(formula = LowBirthWeight ~ PM25, data = data)
summary(ols_model)
```

```{r}
intercept <- ols_model$coefficients[1]
intercept
```


```{r}
slope_coef <- ols_model$coefficients[2]
slope_coef
```

```{r}
std_err <- ols_model$std.error[2]
std_err
```
```{r}
ci_lower <- ols_model$conf.low[2]
ci_lower

ci_upper <- ols_model$conf.high[2]
ci_upper
```

```{r}
# xxx
fit <- ols_model$fitted.values
```

\noindent Answer: The estimated slope coefficient for this model is `r round(slope_coef, 3)`. The estimated slope coefficient means that for a one unit increase in the concentration of PM2.5, percent low birth weight will increase by `r round(std_err, 3)`. The heteroskedasticity-robust standard error for this estimated slope coefficient is `r round(std_err, 3)`. Since the p-value is < 0.05, the effect of PM2.5 on percent low birth weight is statistically significant at the 5 % level.


```{r}
ols_model_plot <- ggplot(data = data, aes(x = PM25, y = LowBirthWeight)) +
  geom_point() +
  geom_smooth(method = lm)
```
\newpage
<center>**Figure 3: OLS Regression of Low Birth Weight on PM 2.5**</center>
```{r, eval=TRUE, echo=FALSE}
ols_model_plot
```

\noindent Figure 3 shows a positive correlation between low birth weight and PM 2.5 based on an Ordinary Least Squares Regression model of low birth weight on PM 2.5.

xxx...read up on "heteroskedasticity-robust standard errors"

```{r}
# xxx...experiment chunk

# data_rm_na <- data %>% 
#   na.omit(LowBirthWeight) %>% 
#   mutate(model_low_birth_wt = ols_model$fitted.values)

fit <- data.frame(ols_model$fitted.values)

fit2 <- data.frame(predict(ols_model, newdata = data, se.fit = TRUE, interval = "confidence"))
```

# Question e:
Suppose a new air quality policy is expected to reduce PM2.5 concentration by 2 micrograms per cubic meters. Predict the new average value of low birth weight and derive its 95% confidence interval. Interpret the 95% confidence interval.

```{r}

# data_reduced_PM <- data %>% 
#   na.omit(LowBirthWeight) %>% 
#   mutate(PM25_reduced = PM25 - 2) %>%
#   mutate(PM25_reduced = case_when(
#     PM25_reduced < 0 ~ 0,
#     PM25_reduced >= 0 ~ PM25_reduced)) %>% 
#   mutate(test = slope_coef * PM25 + intercept) %>% 
#   mutate(test_policy = slope_coef * PM25_reduced + intercept)

  #mutate(model_low_birth_wt = ols_model$fitted.values)

policy_results <- data %>% 
  mutate(PM25_reduced = PM25 - 2) %>%
  mutate(PM25_reduced = case_when(
    PM25_reduced < 0 ~ 0,
    PM25_reduced >= 0 ~ PM25_reduced)) %>% 
  mutate(policy_low_birth_wt = slope_coef * PM25_reduced + intercept) %>% 
  mutate(policy_ci_low = (ci_lower * PM25_reduced + intercept)) %>% 
  mutate(policy_ci_high = (ci_upper * PM25_reduced + intercept))
```

```{r}
mean_policy_low_birth_wt <- mean(policy_results$policy_low_birth_wt)
mean_policy_low_birth_wt

mean_policy_low_birth_wt_ci_low <- mean(policy_results$policy_ci_high)
mean_policy_low_birth_wt_ci_low

mean_policy_low_birth_wt_ci_high <- mean(policy_results$policy_ci_high)
mean_policy_low_birth_wt_ci_high
```

**Following an air quality policy that reduces PM2.5 concentrations by 2 microns per cubic meters, the predicted new average value of percent low birth weight is `r round(mean_policy_low_birth_wt, 3)``**

**The 95% confidence interval for the predicted new average value of percent low birth weight ranges from `r round(mean_policy_low_birth_wt_ci_low, 3)` to  `r round(mean_policy_low_birth_wt_ci_high, 3)`. This means that there is a 95% chance that this interval includes the true average value of percent low birth weight based on the effect of the new policy on PM2.5 concentrations.**

xxx...state what the original low birht wt is and talk about how much it decreases due to the policy

# Question f:
Add the variable Poverty as an explanatory variable to the regression in (d). Interpret the estimated coefficient on Poverty. What happens to the estimated coefficient on PM2.5, compared to the regression in (d). Explain.
```{r}
pm25_poverty_model <- lm_robust(formula = LowBirthWeight ~ PM25 + Poverty, data = data)
summary(pm25_poverty_model)
```

```{r}
poverty_coef <- pm25_poverty_model$coefficients[3]
poverty_coef
```

```{r}
pm25_coef_2 <- pm25_poverty_model$coefficients[2]
pm25_coef_2
```

**The estimated coefficient on poverty is `r round(poverty_coef, 3)`. This mean that for a one unit increase in poverty, percent low birth weighth will increase by `r round(poverty_coef, 3)` while holding PM2.5 constanct**  xxx...check/clean up this interpretation

**In this model, the estimated coefficient on PM2.5 is lower than the coefficient estimated with the model that did not include poverty. This suggests that PM2.5 is not the only variable to influences low birth weight.**


```{r, fig.width = 4, fig.height = 3, eval=TRUE, echo=FALSE}
# xxx...graph just for my reference
pov_model_plot <- ggplot(data = data, aes(x = Poverty, y = LowBirthWeight)) +
  geom_point() +
  geom_smooth(method = lm)
pov_model_plot
```



# Question g:
From the regression in (f), test the null hypothesis that the effect of PM2.5 is equal to the effect of Poverty.

**null hypothesis:**
There is no difference in the estimated slope coefficients for PM2.5 and poverty.  

$$H_{0}: \beta_{1,PM2.5} - \beta_{2,poverty} = 0$$

**alternative hypothesis:** 
There is a difference in the estimated slope coefficient for PM2.5 and poverty.

$$H_{A}: \beta_{1,PM2.5} - \beta_{2,poverty} \neq 0$$
```{r}
se_pm25 <- pm25_poverty_model$std.error[2]
se_pm25

se_poverty <- pm25_poverty_model$std.error[3]
se_poverty

n_pm25 <- length(data$LowBirthWeight[!is.na(data$LowBirthWeight)])
n_pm25

n_poverty <- data %>% 
  filter(!is.na(Poverty)) %>% 
  filter(!is.na(LowBirthWeight)) %>%
  nrow()
n_poverty
```

```{r}
# xxx
# data_pov <- data %>% 
#   filter(!is.na(Poverty)) %>% 
#   filter(!is.na(LowBirthWeight)) %>%
#   nrow()
# data_pov
```


```{r}
# not sure if this is the correct method
se <- sqrt(((se_pm25^2) / n_pm25) + ((se_poverty^2) / n_poverty))
se
```

```{r}
point_est <- pm25_coef_2 - poverty_coef
point_est
```

```{r}
z_score <- (point_est - 0) / se
z_score
```

```{r}
p_value <- 2 * pnorm(point_est, mean = 0, sd = se, lower.tail = FALSE)
p_value
```
**Since the p-values is <0.05 we reject the null hypothesis that the effect of PM2.5 is equal to the effect of poverty.** xxx...check this

```{r}
# xxx
colSums(!is.na(data))
```



xxx...delete everything below here

# Clean and plot data

\noindent The following code loads and cleans the data.

```{r , include=TRUE}

# Load data

data("mtcars")
raw_data <- mtcars

# Clean data

## Add model names as a column 
## [this is just an example manipulation, I rarely assign rownames to a column]

clean_data <- tibble::rownames_to_column(raw_data, "model")


```

\noindent The code chunk below shows how to produce a scatter plot of MPG against weight.  

```{r , include=TRUE}

# Plot 1

plot_1 <- ggplot(clean_data, aes(y=mpg, x = wt))+
  geom_point()+
  theme_cowplot(14)+
  labs(x = "Weight (1000 lbs)", y = "Miles per gallon")

```

\newpage
<center>**Figure 1: MPG and vehicle weight**</center>
```{r , fig.width = 4, fig.height = 3, eval=TRUE, echo=FALSE}
plot_1
```

\noindent Figure 1 shows the expected negative relationship between vehicle weight and MPG.

# Run and interpret regression models

\noindent In order to more formally analyze the relationship between MPG, vehicle weight, and cylinders we estimate the following regression: 

\begin{align}
  Y_{i} = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + u_{i}
\end{align}

\noindent where $Y_{i}$ is MPG for vehicle model $i$, $X_{1i}$ is the vehicle weight, $X_{2i}$ is the number of cylinders in the engine, and $u_{i}$ the regression error term. We will consider a regression including only vehicle weight, and a regression including vehicle weight and number of cylinders.

\medskip

\noindent In R, we run the following code: 

```{r , include=TRUE}

model_1 <- lm(mpg ~ wt, data=clean_data)
model_2 <- lm(mpg ~ wt + cyl, data=clean_data)

```

\noindent Table 1 shows the estimated coeffients from estimating equation (1). 

```{r , results = 'asis', echo = FALSE}
stargazer(model_1, model_2, type = "latex", ci=FALSE, no.space = TRUE, 
          header = FALSE, omit = c("Constant"), omit.stat = c("adj.rsq","ser", "f"),
          covariate.labels = c("Weight (1000 lbs)", "Cylinders"), dep.var.labels = c("MPG"),
          dep.var.caption = c(""),
          title = "MPG and vehicle weight", table.placement = "H")

```

\noindent In model (1), the estimated $\beta_{1}$ coefficient implies that a 1000 pound increase in vehicle weight reduces miles per gallon by 5.3 miles. Adding the number of cylinders in model (2) reduces $\hat{\beta_{1}}$ from -5.3 to -3.2.
